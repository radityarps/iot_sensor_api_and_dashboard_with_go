<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Sensor</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f5f5;
      }
      .header {
        background-color: #007bff;
        color: white;
        padding: 20px 0;
        margin-bottom: 30px;
      }
      .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .current-value {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
        margin: 10px 0;
      }
      .chart-container {
        padding: 15px;
        height: 400px;
      }
      .stats-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
      }
      .stat-item {
        text-align: center;
        padding: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        min-width: 100px;
      }
      .stat-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
      }
      .stat-value {
        font-size: 18px;
        font-weight: bold;
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="container">
        <h1>IoT Sensor Dashboard</h1>
        <p class="mb-0">Real-time monitoring system</p>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <!-- Card Sensor Cahaya (LDR) -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Light Sensor (LDR)</h5>
            </div>
            <div class="card-body">
              <div id="ldrValue" class="current-value">-- lux</div>
              <div class="stats-container">
                <div class="stat-item">
                  <div class="stat-label">Min</div>
                  <div id="ldrMin" class="stat-value">--</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">Average</div>
                  <div id="ldrAvg" class="stat-value">--</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">Max</div>
                  <div id="ldrMax" class="stat-value">--</div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="ldrChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Card Gabungan Suhu & Kelembapan -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Temperature & Humidity</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="current-value" id="dhtSuhuValue">-- °C</div>
                  <div class="stats-container">
                    <div class="stat-item">
                      <div class="stat-label">Min</div>
                      <div id="dhtSuhuMin" class="stat-value">--</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Avg</div>
                      <div id="dhtSuhuAvg" class="stat-value">--</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Max</div>
                      <div id="dhtSuhuMax" class="stat-value">--</div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="current-value" id="dhtKelembapanValue">-- %</div>
                  <div class="stats-container">
                    <div class="stat-item">
                      <div class="stat-label">Min</div>
                      <div id="dhtKelembapanMin" class="stat-value">--</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Avg</div>
                      <div id="dhtKelembapanAvg" class="stat-value">--</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Max</div>
                      <div id="dhtKelembapanMax" class="stat-value">--</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="combinedDhtChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let ldrChart, combinedDhtChart;

      function fetchData() {
        $.getJSON("http://localhost:8080/", function (data) {
          let ldrData = data.find((sensor) => sensor.name === "ldr");
          let dhtSuhuData = data.find((sensor) => sensor.name === "dht_suhu");
          let dhtKelembapanData = data.find(
            (sensor) => sensor.name === "dht_kelembapan"
          );

          // Proses data LDR
          if (
            ldrData &&
            ldrData.sensor_data &&
            ldrData.sensor_data.length > 0
          ) {
            let ldrTimestamps = ldrData.sensor_data.map((entry) =>
              new Date(entry.timestamps).toLocaleTimeString()
            );
            let ldrValues = ldrData.sensor_data.map((entry) => entry.value);
            let latestLdr = ldrValues[ldrValues.length - 1];
            let statusLdr =
              latestLdr > 1500
                ? "Terang"
                : latestLdr > 1000
                ? "Cerah"
                : latestLdr > 500
                ? "Redup"
                : "Gelap";

            $("#ldrValue").text(latestLdr + " lux (" + statusLdr + ")");
            updateChart(ldrChart, ldrTimestamps, ldrValues);
            updateStats("ldr", ldrValues, " lux");
          }

          // Proses data suhu dan kelembapan untuk grafik gabungan
          if (
            dhtSuhuData &&
            dhtSuhuData.sensor_data &&
            dhtSuhuData.sensor_data.length > 0 &&
            dhtKelembapanData &&
            dhtKelembapanData.sensor_data &&
            dhtKelembapanData.sensor_data.length > 0
          ) {
            // Ambil timestamps dari data suhu
            let timestamps = dhtSuhuData.sensor_data.map((entry) =>
              new Date(entry.timestamps).toLocaleTimeString()
            );

            // Ambil nilai suhu dan kelembapan
            let suhuValues = dhtSuhuData.sensor_data.map(
              (entry) => entry.value
            );
            let kelembapanValues = dhtKelembapanData.sensor_data.map(
              (entry) => entry.value
            );

            // Ambil nilai terakhir untuk ditampilkan
            let latestSuhu = suhuValues[suhuValues.length - 1];
            let latestKelembapan =
              kelembapanValues[kelembapanValues.length - 1];

            // Ambil status kelembapan
            let statusKelembapan = dhtKelembapanData.status || "";

            // Update tampilan
            $("#dhtSuhuValue").text(latestSuhu + " °C");
            $("#dhtKelembapanValue").text(
              latestKelembapan + " % (" + statusKelembapan + ")"
            );

            // Update grafik gabungan
            updateCombinedChart(
              combinedDhtChart,
              timestamps,
              suhuValues,
              kelembapanValues
            );

            // Update statistik
            updateStats("dhtSuhu", suhuValues, " °C");
            updateStats("dhtKelembapan", kelembapanValues, " %");
          }
        });
      }

      function updateStats(sensorType, values, unit) {
        if (!values || values.length === 0) return;

        const min = Math.min(...values);
        const max = Math.max(...values);
        const avg = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(
          1
        );

        $(`#${sensorType}Min`).text(min + unit);
        $(`#${sensorType}Max`).text(max + unit);
        $(`#${sensorType}Avg`).text(avg + unit);
      }

      function updateChart(chart, labels, data) {
        if (!chart) return;
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
      }

      function updateCombinedChart(
        chart,
        labels,
        temperatureData,
        humidityData
      ) {
        if (!chart) return;
        chart.data.labels = labels;
        chart.data.datasets[0].data = temperatureData;
        chart.data.datasets[1].data = humidityData;
        chart.update();
      }

      $(document).ready(function () {
        let chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "top",
              labels: {
                font: {
                  size: 14,
                },
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 12,
                },
              },
            },
            x: {
              ticks: {
                font: {
                  size: 12,
                },
              },
            },
          },
          elements: {
            point: {
              radius: 4,
              hoverRadius: 6,
            },
            line: {
              tension: 0.3,
            },
          },
        };

        // Inisialisasi chart LDR
        let ctx1 = document.getElementById("ldrChart").getContext("2d");
        ldrChart = new Chart(ctx1, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Light Intensity",
                borderColor: "#ffc107",
                backgroundColor: "rgba(255, 193, 7, 0.2)",
                borderWidth: 2,
                tension: 0.3,
                data: [],
              },
            ],
          },
          options: chartOptions,
        });

        // Inisialisasi chart gabungan Suhu & Kelembapan
        let ctx2 = document.getElementById("combinedDhtChart").getContext("2d");
        combinedDhtChart = new Chart(ctx2, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Temperature (°C)",
                borderColor: "#dc3545",
                backgroundColor: "rgba(220, 53, 69, 0.2)",
                borderWidth: 2,
                tension: 0.3,
                data: [],
                yAxisID: "y",
              },
              {
                label: "Humidity (%)",
                borderColor: "#17a2b8",
                backgroundColor: "rgba(23, 162, 184, 0.2)",
                borderWidth: 2,
                tension: 0.3,
                data: [],
                yAxisID: "y1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "top",
                labels: {
                  font: {
                    size: 14,
                  },
                },
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: {
                  display: true,
                  text: "Temperature (°C)",
                },
                beginAtZero: true,
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                title: {
                  display: true,
                  text: "Humidity (%)",
                },
                beginAtZero: true,
                grid: {
                  drawOnChartArea: false,
                },
              },
              x: {
                ticks: {
                  font: {
                    size: 12,
                  },
                },
              },
            },
            elements: {
              point: {
                radius: 4,
                hoverRadius: 6,
              },
              line: {
                tension: 0.3,
              },
            },
          },
        });

        fetchData();
        setInterval(fetchData, 5000);
      });
    </script>
  </body>
</html>
